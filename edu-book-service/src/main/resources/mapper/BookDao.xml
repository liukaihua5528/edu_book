<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.book.infrastructure.repositoryImpl.dao.book.BookDao">

    <sql id="pageQueryIsbnFileds">
        c_title as title,
        c_sub_title as subtitle,
        c_pic_url as pic,
        c_author as author,
        c_summary as summary,
        c_publisher as publisher,
        c_isbn_code as isbn
    </sql>

    <sql id="pageQueryFileds">
        detail.c_title as title,
        detail.c_sub_title as subtitle,
        detail.c_pic_url as pic,
        detail.c_author as author,
        detail.c_summary as summary,
        detail.c_publisher as publisher,
        detail.c_public_place as pubplace,
        detail.c_public_date as pubdate,
        detail.c_page as page,
        detail.c_price as price,
        detail.c_binding as binding,
        detail.c_isbn10_code as isbn10,
        detail.c_keyword as keyword,
        detail.c_cip as cip,
        detail.c_edition as edition,
        detail.c_impression as impression,
        detail.c_language as `language`,
        detail.c_format as format,
        detail.c_book_class as `class`,
        detail.c_isbn_code as isbn,
        detail.c_book_uid as bookUid,
        detail.c_garden as garden,
        detail.c_status as bookStatus,
        detail.c_book_audio_url as bookAudioUrl
    </sql>

    <!--fun getIsbnPageTotal(dto: PageQueryBookIsbnDto): Int-->
    <select id="getIsbnPageTotal" parameterType="com.edu.book.domain.book.dto.PageQueryBookIsbnDto" resultType="int">
        SELECT
            COUNT(1)
        FROM
            t_book
        WHERE
            c_is_deleted = 0
        <if test="gardenUid != null and gardenUid != ''">
            AND c_garden_uid = #{gardenUid}
        </if>
    </select>

    <!--fun getPageTotal(dto: PageQueryBookDto): Int-->
    <select id="getPageTotal" parameterType="com.edu.book.domain.book.dto.PageQueryBookDto" resultType="int">
        SELECT
            COUNT(1)
        FROM
            t_book_detail detail
        LEFT JOIN t_book book ON book.c_isbn_code = detail.c_isbn_code AND book.c_is_deleted = 0
        <if test="classifyList != null and classifyList.size > 0">
            LEFT JOIN t_book_detail_classify classify ON classify.c_book_uid = detail.c_book_uid AND classify.c_is_deleted = 0
        </if>
        <if test="ageGroups != null and ageGroups.size > 0">
            LEFT JOIN t_book_detail_age age ON age.c_book_uid = detail.c_book_uid AND age.c_is_deleted = 0
        </if>
        WHERE detail.c_is_deleted = 0
        <include refid="pageQueryCondition"></include>
    </select>

    <!--fun getIsbnPage(dto: PageQueryBookIsbnDto): List<PageQueryBookIsbnResultEntity>-->
    <select id="getIsbnPage" parameterType="com.edu.book.domain.book.dto.PageQueryBookIsbnDto"
        resultType="com.edu.book.domain.book.dto.PageQueryBookIsbnResultEntity">
        SELECT
        <include refid="pageQueryIsbnFileds"/>
        FROM
            t_book
        WHERE
        c_is_deleted = 0
        <if test="gardenUid != null and gardenUid != ''">
            AND c_garden_uid = #{gardenUid}
        </if>
        <bind name="key_offset" value="(page-1) * pageSize"/>
        <if test="page != null and page >= 0 and pageSize != null and pageSize >= 0">
            LIMIT #{key_offset},#{pageSize}
        </if>
    </select>

    <!--fun getPage(dto: PageQueryBookDto): List<PageQueryBookResultDto>-->
    <select id="getPage" parameterType="com.edu.book.domain.book.dto.PageQueryBookDto"
        resultType="com.edu.book.domain.book.dto.PageQueryBookResultEntity">
        SELECT
        <include refid="pageQueryFileds"/>
        FROM
        t_book_detail detail
        LEFT JOIN t_book book ON book.c_isbn_code = detail.c_isbn_code AND book.c_is_deleted = 0
        <if test="classifyList != null and classifyList.size > 0">
            LEFT JOIN t_book_detail_classify classify ON classify.c_book_uid = detail.c_book_uid AND classify.c_is_deleted = 0
        </if>
        <if test="ageGroups != null and ageGroups.size > 0">
            LEFT JOIN t_book_detail_age age ON age.c_book_uid = detail.c_book_uid AND age.c_is_deleted = 0
        </if>
        WHERE detail.c_is_deleted = 0
        <include refid="pageQueryCondition"></include>
        <choose>
            <when test="sort != null and sort != ''">
                ORDER BY detail.${sort} ${orderBy}
            </when>
            <otherwise>
                ORDER BY detail.c_create_time desc
            </otherwise>
        </choose>
        <bind name="key_offset" value="(page-1) * pageSize"/>
        <if test="page != null and page >= 0 and pageSize != null and pageSize >= 0">
            LIMIT #{key_offset},#{pageSize}
        </if>
    </select>

    <sql id="pageQueryCondition">
        <if test="title != null and title != ''">
            AND book.c_title like CONCAT(#{title},'%')
        </if>
        <if test="subTitle != null and subTitle != ''">
            AND book.c_sub_title like CONCAT(#{subTitle},'%')
        </if>
        <if test="isbn != null and isbn != ''">
            AND book.c_isbn_code like CONCAT(#{isbn},'%')
        </if>
        <if test="bookUid != null and bookUid != ''">
            AND detail.c_book_uid like CONCAT(#{bookUid},'%')
        </if>
        <if test="classifyList != null and classifyList.size > 0">
            AND classify.c_classify in
            <foreach collection="classifyList" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="ageGroups != null and ageGroups.size > 0">
            AND age.c_age_group in
            <foreach collection="ageGroups" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
    </sql>

</mapper>
